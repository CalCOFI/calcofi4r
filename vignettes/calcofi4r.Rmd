---
title: "calcofi4r"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{calcofi4r}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning  = FALSE,
  message  = FALSE,
  comment  = "#>")
```

## Introduction

The `calcofi4r` package provides access to the CalCOFI (California Cooperative Oceanic Fisheries Investigations) database, which contains over 75 years of oceanographic and biological data from the California Current ecosystem.

The database is organized into a tidy relational structure stored as Parquet files on Google Cloud Storage. This allows fast queries without downloading the entire database.

## Connect to the Database

```{r connect}
library(calcofi4r)
library(dplyr)
library(DBI)
library(sf)
library(mapview)

# connect to the latest CalCOFI database release
con <- cc_get_db()

# list available tables
dbListTables(con)
```

## Convenience Functions

The package provides convenience functions for common operations:

```{r convenience}
# list available versions
cc_list_versions()

# list tables
cc_list_tables()

# describe a table
cc_describe_table("ichthyo")

# list measurement types
cc_list_measurement_types() |> head(10)
```

### Read Data Directly

Convenience functions return tibbles with optional filtering:

```{r read-convenience}
# read species data
species <- cc_read_species()
head(species)

# read ichthyo data (first 100 rows for demo)
ichthyo_sample <- cc_read_ichthyo() |> head(100)
head(ichthyo_sample)

# read with filtering (lazy query)
anchovy <- cc_read_ichthyo(species_id == 19, collect = FALSE)
anchovy |> head(5) |> collect()
```

## Database Schema

The CalCOFI database contains data from two main programs:

**Ichthyoplankton Survey** (since 1949):

- `cruise` - cruise metadata (691 cruises)
- `ship` - research vessels (48 ships)
- `site` - sampling locations (61K sites)
- `tow` - net tow events (76K tows)
- `net` - net samples (77K nets)
- `ichthyo` - fish larvae counts (831K records)
- `species` - species taxonomy (1,144 species)
- `taxon` - taxonomic hierarchy
- `grid` - CalCOFI station grid (218 cells)
- `segment` - line segments between stations

**Bottle Database** (since 1949):

- `casts` - CTD/bottle cast events (36K casts)
- `bottle` - water sample bottles (895K bottles)
- `bottle_measurement` - oceanographic measurements (11M records)
- `measurement_type` - measurement definitions (47 types)
- `cast_condition` - cast quality flags

```{r schema}
# show row counts for each table
tables <- dbListTables(con)
tibble(
  table = tables,
  rows  = sapply(tables, function(t) {
    dbGetQuery(con, sprintf("SELECT COUNT(*) as n FROM %s", t))$n
  })) |>
  arrange(desc(rows))
```

## Query Bottle Data

The bottle data contains oceanographic measurements from CTD casts. Measurements are stored in a normalized "long" format in `bottle_measurement`.

```{r bottle-temp}
# get temperature measurements with location and depth
d_temp <- dbGetQuery(con, "
  SELECT
    c.lon_dec as lon,
    c.lat_dec as lat,
    c.datetime_utc,
    b.depth_m,
    bm.measurement_value as temperature
  FROM bottle_measurement bm
  JOIN bottle b ON bm.bottle_id = b.bottle_id
  JOIN casts c ON b.cast_id = c.cast_id
  WHERE bm.measurement_type = 'temperature'
    AND bm.measurement_value IS NOT NULL
    AND b.depth_m <= 10
  LIMIT 100000")

head(d_temp)
nrow(d_temp)
```

### Summarize by Location

```{r temp-summary}
# summarize surface temperature by location
d_t <- d_temp |>
  group_by(lon, lat) |>
  summarize(
    n     = n(),
    t_avg = mean(temperature, na.rm = TRUE),
    .groups = "drop") |>
  filter(!is.na(lon), !is.na(lat)) |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)

head(d_t)
```

## CalCOFI Grid

The CalCOFI sampling grid defines standard station positions. The package includes pre-loaded grid data:

- `cc_grid` - station polygons
- `cc_grid_ctrs` - station centroids
- `cc_grid_zones` - aggregated zones by station pattern

```{r grid}
# show the CalCOFI grid colored by zone
mapview(cc_grid, zcol = "zone_key", layer.name = "Zone") +
  mapview(cc_grid_ctrs, cex = 1, col.regions = "black", legend = FALSE)
```

### Grid from Database

The grid is also available in the database with additional attributes:

```{r grid-db}
# query grid from database (includes geometry)
grid_db <- dbGetQuery(con, "SELECT * EXCLUDE(geom, geom_ctr) FROM grid")
head(grid_db)
```

## Show Effort by Grid Cell

Join temperature observations to the CalCOFI grid to show sampling effort:

```{r effort-grid}
# count observations per grid cell
n_grid <- cc_grid |>
  st_join(d_t) |>
  group_by(sta_key) |>
  summarize(n = sum(n, na.rm = TRUE))

mapview(n_grid, zcol = "n", layer.name = "Observations")
```

### Show Effort by Station Point

```{r effort-points}
# join counts to centroids
n_pts <- cc_grid_ctrs |>
  left_join(
    n_grid |> st_drop_geometry() |> select(sta_key, n),
    by = "sta_key")

mapview(n_pts, cex = "n", layer.name = "Observations")
```

## Map Contours

Interpolate temperature data to create contour maps using Inverse Distance Weighting (IDW).

### All Zones

```{r contour-all}
# interpolate points to raster using IDW
r_all <- pts_to_rast_idw(d_t, "t_avg", cc_grid_zones)

# generate contour polygons
p_all <- rast_to_contours(r_all, cc_grid_zones)
mapview(p_all, zcol = "z_avg", layer.name = "Temp (C)")
```

### Standard and Extended Pattern

```{r contour-ext}
# filter to standard + extended zones
aoi_ext <- cc_grid_zones |>
  filter(sta_pattern %in% c("standard", "extended"))

# interpolate and contour
r_ext <- pts_to_rast_idw(d_t, "t_avg", aoi_ext)
p_ext <- rast_to_contours(r_ext, aoi_ext)
mapview(p_ext, zcol = "z_avg", layer.name = "Temp (C)")
```

## Query Ichthyoplankton Data

The ichthyoplankton survey counts fish larvae by species across sampling sites.

```{r ichthyo}
# get top 10 species by total count
top_species <- dbGetQuery(con, "
  SELECT
    s.scientific_name,
    s.common_name,
    SUM(i.tally) as total_count,
    COUNT(DISTINCT n.tow_id) as n_tows
  FROM ichthyo i
  JOIN species s ON i.species_id = s.species_id
  JOIN net n ON i.net_id = n.net_id
  GROUP BY s.scientific_name, s.common_name
  ORDER BY total_count DESC
  LIMIT 10")

top_species
```

### Species Distribution

Map the distribution of a common species:

```{r species-map}
# get Northern Anchovy observations with locations
anchovy <- dbGetQuery(con, "
  SELECT
    si.latitude as lat,
    si.longitude as lon,
    SUM(i.tally) as count
  FROM ichthyo i
  JOIN species sp ON i.species_id = sp.species_id
  JOIN net n ON i.net_id = n.net_id
  JOIN tow t ON n.tow_id = t.tow_id
  JOIN site si ON t.site_id = si.site_id
  WHERE sp.scientific_name = 'Engraulis mordax'
  GROUP BY si.latitude, si.longitude") |>
  filter(!is.na(lon), !is.na(lat)) |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

mapview(anchovy, cex = "count", layer.name = "Anchovy count")
```

## Cruise Timeline

View the temporal coverage of CalCOFI cruises:

```{r cruises}
# get cruise timeline (date_ym is YYYYMM format)
cruises <- dbGetQuery(con, "
  SELECT
    cruise_key,
    CAST(SUBSTRING(CAST(date_ym AS VARCHAR), 1, 4) AS INTEGER) as year,
    CAST(SUBSTRING(CAST(date_ym AS VARCHAR), 5, 2) AS INTEGER) as month,
    ship_key
  FROM cruise
  WHERE date_ym IS NOT NULL
  ORDER BY date_ym")

# count cruises by year
cruises |>
  count(year) |>
  filter(!is.na(year)) |>
  ggplot2::ggplot(ggplot2::aes(year, n)) +
  ggplot2::geom_col(fill = "steelblue") +
  ggplot2::labs(
    title = "CalCOFI Cruises by Year",
    x = "Year", y = "Number of Cruises") +
  ggplot2::theme_minimal()
```

## Available Measurement Types

The bottle database includes many oceanographic variables:

```{r measurements}
# list all measurement types
dbGetQuery(con, "
  SELECT measurement_type, description, units
  FROM measurement_type
  ORDER BY measurement_type") |>
  head(20)
```

## Disconnect

Always close the database connection when finished:

```{r disconnect}
dbDisconnect(con)
```

## Package Data Objects

The package also includes pre-loaded spatial data objects for convenience:

- `cc_grid` - CalCOFI station grid polygons (sf)
- `cc_grid_ctrs` - Station centroids (sf)
- `cc_grid_zones` - Aggregated zone polygons (sf)
- `cc_bottle` - Sample bottle data for examples (tibble)

These can be used without connecting to the database for quick spatial operations.
